---
title: CisTopic on 10X RNA/ATAC
layout: cedar_analysis
author: Ryan Mulqueen
permalink: /cistopic_10xatac/
category: CEDAR
---

Running cisTopic on 10X Genomic ATAC/RNA Coassay (just the ATAC part). Taking Suerat Objects generated by Aaron Doe.

## File Location
```bash
/home/groups/CEDAR/doe/projects/ATACRNA/MCF7_justATAC_SO.rds
/home/groups/CEDAR/doe/projects/ATACRNA/T47D_justATAC_SO.rds
```

## Cistopic on ATAC data

```R
setwd("/home/groups/CEDAR/mulqueen/projects/10x_atacrna")
library(Signac)
library(Seurat)
library(SeuratWrappers)
library(cisTopic)
set.seed(1234)

mcf7<-readRDS("/home/groups/CEDAR/doe/projects/ATACRNA/MCF7_justATAC_SO.rds") #generated by AD
t47d<-readRDS("/home/groups/CEDAR/doe/projects/ATACRNA/T47D_justATAC_SO.rds") #generated by AD

combined<- merge(mcf7, y = t47d, add.cell.ids = c("mcf7", "t47d"), project = "atac_rna")
saveRDS(combined,"210924_cellline.SeuratObject.Rds")

cistopic_generation<-function(x,name_out,outdir){
	wd<-outdir
    outname<-name_out
    atac_sub<-readRDS(x)
    cistopic_counts_frmt<-atac_sub$peaks@counts
    row.names(cistopic_counts_frmt)<-sub("-", ":", row.names(cistopic_counts_frmt))
    sub_cistopic<-cisTopic::createcisTopicObject(cistopic_counts_frmt)
    print("made cistopic object")
    sub_cistopic_models<-cisTopic::runWarpLDAModels(sub_cistopic,topic=c(10:30),nCores=7,addModels=FALSE)
    saveRDS(sub_cistopic_models,
        file=paste0(wd,"/",outname,".CisTopicObject.Rds"))
    print("finshed running cistopic")

    pdf(paste0(wd,"/",outname,"_model_selection.pdf"))
    par(mfrow=c(3,3))
    sub_cistopic_models<- selectModel(sub_cistopic_models, type='derivative')
    dev.off()
    }

cistopic_generation(x=combined,name_out="210924_cellline",outdir="/home/groups/CEDAR/mulqueen/projects/10x_atacrna")

```

### ChromVar for Transcription Factor Motifs


```R
  library(Signac)
  library(Seurat)
  library(JASPAR2020)
  library(TFBSTools)
  library(BSgenome.Hsapiens.UCSC.hg38)
  library(patchwork)
  set.seed(1234)

  #lowerign cores to be used by chromvar to 10
  library(BiocParallel)
  register(MulticoreParam(10))

setwd("/home/groups/CEDAR/mulqueen/projects/10x_atacrna")

combined<-readRDS("210924_cellline.SeuratObject.Rds")


  #Read in data and modify to monocle CDS file
  #read in RDS file.

  # Get a list of motif position frequency matrices from the JASPAR database
  pfm <- getMatrixSet(
    x = JASPAR2020,
    opts = list(species =9606, all_versions = FALSE))

  # Scan the DNA sequence of each peak for the presence of each motif, using orgo_atac for all objects (shared peaks)
  motif.matrix.hg38 <- CreateMotifMatrix(
    features = granges(combined[["peaks"]]),
    pwm = pfm,
    genome = 'hg38',
    use.counts = FALSE)

  # Create a new Mofif object to store the results
  motif.hg38 <- CreateMotifObject(
    data = motif.matrix.hg38,
    pwm = pfm)

  #for human
   hg38_atac <- SetAssayData(
    object = combined,
    assay = 'peaks',
    slot = 'motifs',
    new.data = motif.hg38)

  combined <- RegionStats(object = combined, genome = BSgenome.Hsapiens.UCSC.hg38)
  combined <- RunChromVAR( object = combined,genome = BSgenome.Hsapiens.UCSC.hg38)
  saveRDS(combined,file="210924_cellline.SeuratObject.Rds")


#define DA functions for parallelization
#Use LR test for atac data
da_one_v_rest<-function(i,obj,group,assay.="chromvar",latent.vars.="nCount_peaks"){
    da_ga_tmp <- FindMarkers(
        object = obj,
        ident.1 = i,
        group.by = group,
        test.use = 'LR',
        latent.vars = latent.vars.,
        only.pos=T,
        assay=assay.
        )
    da_ga_tmp$da_region<-row.names(da_ga_tmp)
    da_ga_tmp$enriched_group<-c(i)
    da_ga_tmp$compared_group<-c("all_other_cells")
    return(da_ga_tmp)
  }


n.cores=10 #Perform parallel application of DA test
da_ga<-mclapply(
    cluster_to_test,
    FUN=da_one_v_rest,
    obj=hg38_atac,
    group="cluster_ID", #this to be changed
    assay.="chromvar",
    mc.cores=n.cores)

da_ga_df<-do.call("rbind",da_ga) #Merge the final data frame from the list for 1vrest DA
write.table(da_ga_df,file="210924_cellline..onevrest.da_chromvar.txt",sep="\t",col.names=T,row.names=T,quote=F)


```